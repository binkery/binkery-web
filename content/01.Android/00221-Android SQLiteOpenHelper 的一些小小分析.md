# Android SQLiteOpenHelper 的一些小小分析
- 2013-04-17 09:27:46
- 
- android,sqlite,数据库,

就目前而言，SQLiteOpenHelper 的 onCreate() 方法是在第一次调用getWritableDatabase() 方法的时候被调用。<div><br /></div><div>写一个子类，继承于SQLiteOpenHelper，使用的时候调用他的构造方法。构造方法有两个。</div><div><div>&nbsp; &nbsp; public SQLiteOpenHelper(Context context, String name, CursorFactory factory, int version) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; this(context, name, factory, version, new DefaultDatabaseErrorHandler());</div><div>&nbsp; &nbsp; }</div></div><div><br /></div><div><div>&nbsp; &nbsp; public SQLiteOpenHelper(Context context, String name, CursorFactory factory, int version,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DatabaseErrorHandler errorHandler) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (version &lt; 1) throw new IllegalArgumentException("Version must be &gt;= 1, was " + version);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (errorHandler == null) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw new IllegalArgumentException("DatabaseErrorHandler param value can't be null.");</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; mContext = context;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; mName = name;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; mFactory = factory;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; mNewVersion = version;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; mErrorHandler = errorHandler;</div><div>&nbsp; &nbsp; }</div></div><div><br /></div><div>一般使用第一个。</div><div><br /></div><div>下面是getWritableDatabase() 方法的源码</div><div><div>&nbsp; &nbsp; public synchronized SQLiteDatabase getWritableDatabase() {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (mDatabase != null) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!mDatabase.isOpen()) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // darn! the user closed the database by calling mDatabase.close()</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mDatabase = null;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else if (!mDatabase.isReadOnly()) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return mDatabase; &nbsp;// The database is already open for business</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (mIsInitializing) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw new IllegalStateException("getWritableDatabase called recursively");</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; // If we have a read-only database open, someone could be using it</div><div>&nbsp; &nbsp; &nbsp; &nbsp; // (though they shouldn't), which would cause a lock to be held on</div><div>&nbsp; &nbsp; &nbsp; &nbsp; // the file, and our attempts to open the database read-write would</div><div>&nbsp; &nbsp; &nbsp; &nbsp; // fail waiting for the file lock. &nbsp;To prevent that, we acquire the</div><div>&nbsp; &nbsp; &nbsp; &nbsp; // lock on the read-only database, which shuts out other users.</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; boolean success = false;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; SQLiteDatabase db = null;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (mDatabase != null) mDatabase.lock();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; try {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mIsInitializing = true;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (mName == null) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db = SQLiteDatabase.create(null);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db = mContext.openOrCreateDatabase(mName, 0, mFactory, mErrorHandler);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int version = db.getVersion();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (version != mNewVersion) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db.beginTransaction();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (version == 0) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; onCreate(db);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (version &gt; mNewVersion) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; onDowngrade(db, version, mNewVersion);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; onUpgrade(db, version, mNewVersion);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db.setVersion(mNewVersion);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db.setTransactionSuccessful();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } finally {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db.endTransaction();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; onOpen(db);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; success = true;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return db;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; } finally {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mIsInitializing = false;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (success) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (mDatabase != null) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try { mDatabase.close(); } catch (Exception e) { }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mDatabase.unlock();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mDatabase = db;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (mDatabase != null) mDatabase.unlock();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (db != null) db.close();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; }</div></div><div><br /></div><div>下面是getReadableDatabase()方法的源码</div><div><div>&nbsp; &nbsp; &nbsp;public synchronized SQLiteDatabase getReadableDatabase() {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (mDatabase != null) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!mDatabase.isOpen()) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // darn! the user closed the database by calling mDatabase.close()</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mDatabase = null;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return mDatabase; &nbsp;// The database is already open for business</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (mIsInitializing) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw new IllegalStateException("getReadableDatabase called recursively");</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; try {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return getWritableDatabase();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; } catch (SQLiteException e) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (mName == null) throw e; &nbsp;// Can't open a temp database read-only!</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Log.e(TAG, "Couldn't open " + mName + " for writing (will try read-only):", e);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; SQLiteDatabase db = null;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; try {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mIsInitializing = true;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; String path = mContext.getDatabasePath(mName).getPath();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db = SQLiteDatabase.openDatabase(path, mFactory, SQLiteDatabase.OPEN_READONLY,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mErrorHandler);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (db.getVersion() != mNewVersion) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw new SQLiteException("Can't upgrade read-only database from version " +</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db.getVersion() + " to " + mNewVersion + ": " + path);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; onOpen(db);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Log.w(TAG, "Opened " + mName + " in read-only mode");</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mDatabase = db;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return mDatabase;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; } finally {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mIsInitializing = false;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (db != null &amp;&amp; db != mDatabase) db.close();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; }</div></div><div><br /></div><div>从上面的源码可以看出</div><div>1 。 这个类是对Context.openOrCreateDatabase() 的封装（Google官网本来就是那么说的，有点废话了）。</div><div>2 。 在大部分情况下，getReadableDatabase() 和 getWritableDatabase() 效果是一样的。返回的是同一个mDatabase对象。特殊情况是指内存空间不足，不能继续往数据库里写东西类似的情况。如果调用getWritableDatabase()方法，会抛出一个异常。如果调用getReadableDatabase()的话，会尝试返回一个只读的Database对象。当然还是可能抛异常。</div><div>3 。 onCreate()方法在第一次调用getWritableDatabase()方法的时候被调用。当然如果第一次调用getReadableDatabase()方法也会调用onCreate()方法。</div>